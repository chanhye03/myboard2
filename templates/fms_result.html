{% extends 'base.html' %} 

{% block title %}FMS 통합 분석 결과{% endblock %} 

{% block content %}
<style>
    #chickModal {
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .modal-content {
        transform: translateY(20px);
        transition: transform 0.3s ease;
    }
    #chickModal.active {
        opacity: 1;
        visibility: visible;
    }
    #chickModal.active .modal-content {
        transform: translateY(0);
    }
</style>

<div class="space-y-6">
  <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 border-b border-slate-700 pb-6">
    <div>
      <h2 class="text-3xl font-extrabold text-white tracking-tight">FMS 통합 데이터 분석 결과</h2>
      <p class="text-slate-400 text-xs mt-1 sys-font uppercase tracking-widest opacity-60">Integrated Factory Monitoring System</p>
    </div>
    <div class="text-right">
      <span class="text-slate-500 text-[10px] uppercase tracking-tighter sys-font">Total Records</span>
      <div class="text-3xl font-black text-indigo-400 sys-font leading-none">{{ total_count if total_count else results|length }}</div>
    </div>
  </div>

  <div class="flex justify-start items-center gap-3">
    <div class="bg-slate-200 px-3 py-1 rounded-md shadow-inner flex items-center">
        <select onchange="changePerPage(this.value)" class="bg-transparent border-none text-white text-xs font-bold outline-none focus:ring-0 cursor-pointer appearance-none sys-font">
            {% for i in range(10, 60, 10) %}
            <option value="{{ i }}" {% if per_page == i %}selected{% endif %}>{{ i }}개씩 보기</option>
            {% endfor %}
        </select>
        <i class="fas fa-chevron-down text-[8px] text-white ml-2 pointer-events-none"></i>
    </div>
  </div>

  <div class="bg-slate-800/40 border border-slate-700 rounded-2xl overflow-hidden shadow-2xl backdrop-blur-sm">
    <div class="overflow-x-auto">
      <table class="w-full text-left border-collapse sys-font">
        <thead>
          <tr class="bg-slate-900/50 text-slate-400 uppercase text-[11px] font-bold tracking-widest">
            {% if results and results|length > 0 %}
              {% for column in results[0].keys() %}
              <th class="py-5 px-1.5 border-b border-slate-700/50 text-center whitespace-nowrap">{{ column }}</th>
              {% endfor %}
            {% endif %}
          </tr>
        </thead>
        <tbody class="text-slate-300 divide-y divide-slate-700/30">
          {% for row in results %}
          <tr class="hover:bg-indigo-500/5 transition-colors">
            {% for key, value in row.items() %}
            <td class="py-4 px-6 text-center text-[13px] whitespace-nowrap">
              {% if key == '육계번호' %}
                <button onclick="openChickModal('{{ value }}')" class="text-indigo-400 hover:text-indigo-300 font-bold underline decoration-indigo-500/30 underline-offset-4">
                  {{ value }}
                </button>
              {% elif value == 'Pass' %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-[10px] font-bold text-green-400 border border-green-500/30 bg-green-500/10">
                  <span class="w-1 h-1 bg-green-400 rounded-full mr-2"></span>{{ value }}
                </span>
              {% elif value == 'Fail' %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-[10px] font-bold text-red-400 border border-red-500/30 bg-red-500/10">
                  <span class="w-1 h-1 bg-red-400 rounded-full mr-2 animate-blink"></span>{{ value }}
                </span>
              {% else %}
                <span class="opacity-80">{{ value }}</span>
              {% endif %}
            </td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {% if total_pages and total_pages > 1 %}
  <div class="flex justify-center mt-10 pb-8">
    <nav class="flex items-center gap-2 sys-font">
      <a href="{{ url_for('fms_list', page=page-1, per_page=per_page) }}" class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-800 border border-slate-700 text-slate-500 hover:text-white {% if page == 1 %}opacity-20 pointer-events-none{% endif %}">
         <i class="fas fa-chevron-left text-xs"></i>
      </a>
      {% for p in range(1, total_pages + 1) %}
        {% if p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
          <a href="{{ url_for('fms_list', page=p, per_page=per_page) }}" class="w-10 h-10 flex items-center justify-center rounded-xl font-bold {% if p == page %}bg-indigo-600 text-white shadow-lg{% else %}bg-slate-800 border border-slate-700 text-slate-400 hover:text-white{% endif %}">
             {{ p }}
          </a>
        {% elif p == page - 3 or p == page + 3 %}
          <span class="text-slate-700 px-1">...</span>
        {% endif %}
      {% endfor %}
      <a href="{{ url_for('fms_list', page=page+1, per_page=per_page) }}" class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-800 border border-slate-700 text-slate-500 hover:text-white {% if page == total_pages %}opacity-20 pointer-events-none{% endif %}">
         <i class="fas fa-chevron-right text-xs"></i>
      </a>
    </nav>
  </div>
  {% endif %}
</div>

<div id="chickModal" class="fixed inset-0 z-[100] flex items-center justify-center opacity-0 invisible bg-black/80 backdrop-blur-sm">
    <div class="modal-content w-full max-w-lg bg-slate-900 bg-black border border border-slate-700 rounded-3xl p-8 shadow-2xl">
        <div class="flex justify-between items-center mb-6 border-b border-slate-800 pb-4">
            <h3 class="text-xl font-bold text-white"><i class="fas fa-search-location mr-3 text-white-500"></i>개체 상세 정보</h3>
            <button onclick="closeModal()" class="text-slate-500 hover:text-white transition-colors text-2xl">&times;</button>
        </div>
        <div id="modalBody" class="space-y-4 sys-font text-sm">
            <p class="text-slate-500 animate-pulse">데이터를 로드하는 중...</p>
        </div>
        <div class="mt-8 flex justify-end">
            <button onclick="closeModal()" class="bg-slate-800 text-white px-6 py-2 rounded-xl hover:bg-slate-700 transition-all font-bold">닫기 (Close)</button>
        </div>
    </div>
</div>

<script>
    // 페이지 개수 변경 함수
    function changePerPage(perPage) {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('per_page', perPage);
        urlParams.set('page', 1);
        window.location.search = urlParams.toString();
    }

    // 모달 열기 함수
    function openChickModal(chickNo) {
        const modal = document.getElementById('chickModal');
        const body = document.getElementById('modalBody');
        
        modal.classList.add('active');
        body.innerHTML = '<p class="text-indigo-400 animate-pulse">데이터를 서버에서 가져오고 있습니다...</p>';

        // API 호출
        fetch(`/api/chick_info/${chickNo}`)
            .then(response => response.json())
            .then(데이터 => {
                if(데이터.error) {
                    body.innerHTML = `<p class="text-red-500 font-bold">${데이터.error}</p>`;
                } else {
                    const 항목사전 = {
                        'code_desc': '품종명',
                        'chick_no': '육계번호',
                        'gender': '성별',
                        'farm': '농장',
                        'hatchday': '부화일',
                        'egg_weight': '종란무게(g)',
                        'vaccination1': '1차 백신',
                        'vaccination2': '2차 백신'
                    };

                    // 2. 팝업에 노출할 순서 (breeds, code 같은 ID는 제외하고 이름만 노출)
                    const 표시순서 = ['chick_no', 'farm', 'code_desc', 'gender', 'hatchday', 'egg_weight', 'vaccination1', 'vaccination2'];

                    let html = '<div class="grid grid-cols-2 gap-4">';
                    
                    표시순서.forEach(키 => {
                        const 라벨 = 항목사전[키] || 키;
                        let 값 = 데이터[키] || 데이터[키.toUpperCase()]; // 대소문자 모두 대응

                        // 데이터 가공 (null 처리 및 날짜 형식 등)
                        if (값 === null || 값 === undefined) {
                            값 = '-';
                        } else if (키 === 'hatchday') {
                            const 날짜객체 = new Date(값);
                            if (!isNaN(날짜객체)) {
                                const 년 = 날짜객체.getFullYear();
                                const 월 = String(날짜객체.getMonth() + 1).padStart(2, '0');
                                const 일 = String(날짜객체.getDate()).padStart(2, '0');                                
                                값 = `${년}-${월}-${일}`;
                            }
                        } else if (키.includes('vaccination')) {
                            값 = (값 === '1' || 값 === 1 || 값 === 'Pass') ? '<span class="text-green-400">접종 완료</span>' : '<span class="text-red-400">미접종</span>';
                        }

                        html += `
                            <div class="bg-slate-800/60 p-4 rounded-xl border border-slate-700/50 shadow-inner group hover:border-indigo-500/50 transition-all">
                                <div class="text-[10px] text-slate-500 uppercase tracking-widest mb-1 font-bold">${라벨}</div>
                                <div class="text-indigo-300 font-black text-sm sys-font">${값}</div>
                            </div>
                        `;
                    });

                    html += '</div>';
                    body.innerHTML = html;
                }
            })
            .catch(err => {
                body.innerHTML = `<p class="text-red-500">시스템 통신 오류가 발생했습니다.</p>`;
            });
    }

    // 모달 닫기 함수
    function closeModal() {
        document.getElementById('chickModal').classList.remove('active');
    }

    // 배경 클릭 시 닫기
    window.onclick = function(event) {
        const modal = document.getElementById('chickModal');
        if (event.target == modal) {
            closeModal();
        }
    }
</script>
{% endblock %}